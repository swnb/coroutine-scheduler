# 协程原理解释视频

## 通用的场景基本描述

左边是栈（长方形，垂直分布），上方标记高地址，下方标记低地址，划分成一个个小方块

sp 指针箭头一开始指向栈上的高地址块，并且在视频中不断的变化

右边是代码区域，代码变化会推动左边的动画演示

代码区域固定显示完整代码，通过移动的框框标记当前执行到哪行代码

## 场景 1: 函数调用 sp 和栈数据的变化

### 目的

说明函数调用时候函数栈帧的变化行为，强调栈帧内部的局部变量分配

### 材料

1. 代码（右侧固定显示，不消失）
  ```python
  def main():
      a = 1
      b = 2
      c = add(a,b)
      log(c)

  def add(a,b):
      return a+b

  def log(value):
      print(value)
  ```

### 动画步骤详解

每个动画的间隔应该在 3s-4s

#### 初始状态
1. SP指针在栈顶高地址位置
2. 右边固定显示完整代码
3. 栈为空白状态

#### Main函数调用
4. 代码框框移动到 `def main():` 行
5. SP指针向下移动，为main函数分配栈帧空间（例如32字节，8个槽位）
6. 创建main函数栈帧，用蓝色背景区分，标记为"main()"
7. 在main栈帧的顶部（靠近旧SP位置）放置返回地址lr，有框框闪烁效果

#### Main函数内部变量分配
8. 代码框框移动到 `a = 1` 行
9. 在main栈帧内部（不是栈顶，而是main栈帧范围内）创建变量a=1的槽位，有框框闪烁效果
10. 代码框框移动到 `b = 2` 行
11. 在main栈帧内部创建变量b=2的槽位，有框框闪烁效果

#### Add函数调用
12. 代码框框移动到 `c = add(a,b)` 行
13. 代码框框移动到 `def add(a,b):` 行（跳转到函数定义）
14. SP指针继续向下移动，为add函数分配新的栈帧空间
15. 创建add函数栈帧，用绿色背景区分，标记为"add()"
16. 在add栈帧顶部放置返回地址lr
17. 在add栈帧内部放置参数a=1, b=2的副本

#### Add函数执行和返回
18. 代码框框移动到 `return a+b` 行
19. 在add栈帧内可能显示临时计算结果
20. add函数栈帧整体销毁（淡出效果）
21. SP指针回退到main栈帧的位置
22. 代码框框回到 `c = add(a,b)` 行

#### Main函数继续执行
23. 在main栈帧内部创建变量c=3的槽位，有框框闪烁效果

#### Log函数调用（重复add函数的模式）
24. 代码框框移动到 `log(c)` 行
25. 代码框框移动到 `def log(value):` 行
26. 创建log函数栈帧（紫色背景），标记为"log()"
27. 在log栈帧内放置参数value=3
28. 代码框框移动到 `print(value)` 行
29. log函数栈帧销毁，SP回退

#### 程序结束
30. main函数栈帧销毁
31. SP指针回到初始高地址位置
32. 代码框框消失或移动到程序结束位置

### 关键改进点

1. **代码区域固定**：右侧代码始终显示，不会消失
2. **框框指示器**：移动的框框清楚指示当前执行位置
3. **栈帧内操作**：所有变量操作都在对应的函数栈帧内进行
4. **层次关系清晰**：不同函数的栈帧有明显的视觉区分
5. **SP指针精确**：SP移动与栈帧创建/销毁完全对应

